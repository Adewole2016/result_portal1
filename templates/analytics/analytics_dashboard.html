{% extends 'base/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Result Computation Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-bar me-2"></i>Analytics Dashboard</h2>
            <a href="{% url 'accounts:dashboard' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Overall Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Students</h5>
                        <h3>{{ total_students }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Courses</h5>
                        <h3>{{ total_courses }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Lecturers</h5>
                        <h3>{{ total_lecturers }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chalkboard-teacher fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Results Uploaded</h5>
                        <h3>{{ total_results_uploaded }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-file-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Course Performance -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top Performing Courses</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Title</th>
                                <th>Avg Score</th>
                                <th>Highest</th>
                                <th>Lowest</th>
                                <th>Students</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in course_performance %}
                            <tr>
                                <td>{{ course.code }}</td>
                                <td>{{ course.title|truncatechars:20 }}</td>
                                <td>{{ course.avg_score|floatformat:1|default:"-" }}</td>
                                <td>{{ course.highest_score|default:"-" }}</td>
                                <td>{{ course.lowest_score|default:"-" }}</td>
                                <td>{{ course.num_results }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No course performance data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Students by CGPA -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-medal me-2"></i>Top Students by CGPA</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Matric No</th>
                                <th>Full Name</th>
                                <th>Avg CGPA</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in top_students_cgpa %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ student.student__matric_no }}</td>
                                <td>{{ student.student__user__first_name }} {{ student.student__user__last_name }}</td>
                                <td>{{ student.avg_cgpa|floatformat:2|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No student performance data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Department Performance -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-building me-2"></i>Department Performance</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Code</th>
                                <th>Average GPA</th>
                                <th>Performance Rating</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for department in department_performance %}
                            <tr>
                                <td>{{ department.name }}</td>
                                <td>{{ department.code }}</td>
                                <td>{{ department.avg_gpa|floatformat:2|default:"-" }}</td>
                                <td>
                                    {% if department.avg_gpa %}
                                        {% if department.avg_gpa >= 4.0 %}
                                            <span class="badge bg-success">Excellent</span>
                                        {% elif department.avg_gpa >= 3.0 %}
                                            <span class="badge bg-primary">Good</span>
                                        {% elif department.avg_gpa >= 2.0 %}
                                            <span class="badge bg-warning">Average</span>
                                        {% else %}
                                            <span class="badge bg-danger">Needs Improvement</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">No Data</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No department performance data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Session/Semester Info -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Current Session</h5>
            </div>
            <div class="card-body">
                {% if current_session %}
                    <h4>{{ current_session.name }}</h4>
                    <p class="text-muted">{{ current_session.start_year }} - {{ current_session.end_year }}</p>
                {% else %}
                    <p class="text-muted">No current session set</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Current Semester</h5>
            </div>
            <div class="card-body">
                {% if current_semester %}
                    <h4>{{ current_semester.get_semester_display }}</h4>
                    <p class="text-muted">{{ current_semester.session.name }}</p>
                {% else %}
                    <p class="text-muted">No current semester set</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Add any JavaScript for charts or interactive elements here
    // For example, you could use Chart.js to create visual charts
</script>
{% endblock %}

