{% extends 'base/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Broadsheet - Result Computation Portal{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2>Broadsheet</h2>
        <a href="{% url 'results:dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>
</div>

<!-- Filter Form -->
<div class="row mb-4">
    <div class="col-12">
        <form method="get" class="row g-3">
            <div class="col-md-3">{{ form.department.label_tag }} {{ form.department }}</div>
            <div class="col-md-3">{{ form.session.label_tag }} {{ form.session }}</div>
            <div class="col-md-3">{{ form.semester.label_tag }} {{ form.semester }}</div>
            <div class="col-md-3">{{ form.level.label_tag }} {{ form.level }}</div>
            <div class="col-12 text-end"><button class="btn btn-primary">Generate Broadsheet</button></div>
        </form>
    </div>
</div>

{% if broadsheet_data %}
<div class="table-responsive">
    <table class="table table-bordered table-hover table-sm">
        <thead>
            <tr>
                <th rowspan="2">S/N</th>
                <th rowspan="2">Matric No</th>
                <th rowspan="2">Full Name</th>
                <th colspan="{{ all_courses|length }}" class="text-center">Courses & Units</th>
                <th rowspan="2">TNU</th>
                <th rowspan="2">TCP</th>
                <th rowspan="2">GPA</th>
                {% if show_prev %}
                    <th rowspan="2">PTNU</th>
                    <th rowspan="2">PTCP</th>
                    <th rowspan="2">PGPA</th>
                    <th rowspan="2">CTNU</th>
                    <th rowspan="2">CTCP</th>
                    <th rowspan="2">CGPA</th>
                {% endif %}
                <th rowspan="2">Failed Courses</th>
                <th rowspan="2">Remark</th>
            </tr>
            <tr>
                {% for course in all_courses %}
                    <th class="text-center">{{ course.code }}<br>{{ course.credit_units }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in broadsheet_data %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ row.student.matric_no }}</td>
                <td>{{ row.student.user.get_full_name }}</td>
                {% for course in all_courses %}
                    <td class="text-center">{{ row.course_scores|get_item:course.code|default:"0" }}</td>
                {% endfor %}
                <td class="text-center">{{ row.tnu }}</td>
                <td class="text-center">{{ row.tcp }}</td>
                <td class="text-center">{{ row.gpa|floatformat:2 }}</td>
                {% if show_prev %}
                    <td class="text-center">{{ row.prev_tnu }}</td>
                    <td class="text-center">{{ row.prev_tcp }}</td>
                    <td class="text-center">{{ row.prev_gpa|floatformat:2 }}</td>
                    <td class="text-center">{{ row.ctnu }}</td>
                    <td class="text-center">{{ row.ctcp }}</td>
                    <td class="text-center">{{ row.cgpa|floatformat:2 }}</td>
                {% endif %}
                <td class="text-center">
                    {% if row.failed_courses %}
                        {{ row.failed_courses|join:", " }}
                    {% else %}
                        
                    {% endif %}
                </td>
                <td class="text-center">
                    {% if row.failed_courses %}
                        FAILED
                    {% else %}
                        PASSED
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="mt-3">
        <p><strong>Total Students in Class =</strong> {{ total_students }}</p>
        <p><strong>No of Students Passed =</strong> {{ total_passed }} ({{ percent_passed }}%)</p>
        <p><strong>No of Students Failed =</strong> {{ total_failed }} ({{ percent_failed }}%)</p>
    </div>
</div>
{% else %}
<div class="alert alert-warning">No broadsheet data found for the selected criteria.</div>
{% endif %}
{% endblock %}
